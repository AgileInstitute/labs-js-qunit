<!Doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>phaserPinning.test</title>
  <link rel="stylesheet" href="../../../lib/qunit.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="../../../lib/qunit.js"></script>
  <script src="../../../lib/jquery.js"></script>
  <script src="../../../lib/sinon.js"></script>
  <script src="../StarTrek/game.js"></script>
  <script src="../StarTrek/klingon.js"></script>
  <script src="../Untouchables/userInterface.js"></script>
  <script>

    module("phaser", {
        setup: function() {
			// given
            this.game = new Game();
            this.ui = new UserInterface("phaser");
            sinon.stub(this.ui, "writeLine");
        }
    });

    test("PhasersFiredWithInsufficientEnergy", function() {
        // given
        this.ui.commandParameter = this.game.energy + 1;

        // when
        this.game.processCommand(this.ui);

        // then
        equal(this.ui.writeLine.args[0], "Insufficient energy to fire phasers!", "message");
    });

    test("EnergyExpendedEvenWhenPhasersFiredWhileKlingonOutOfRange", function() {
        // given
        var outOfRange = this.game.maxPhaserRange + 1;
        var klingon = new Klingon();
        klingon.distance = outOfRange;
        this.ui.target = klingon;
        this.ui.commandParameter = 1000;
        var energyBefore = this.game.e;

        // when
        this.game.processCommand(this.ui);

        // then
        equal(this.ui.writeLine.args[0], "Klingon out of range of phasers at " + outOfRange + " sectors...", "message");
        equal(this.game.e, energyBefore - 1000, "energy deducted");
    });

    test("PhasersFiredKlingonDestroyed", function() {
        // given
        var klingon = new Klingon();
        klingon.distance = 2000;
        klingon.energy = 200;
        sinon.spy(klingon, "destroy");
        this.ui.target = klingon;
        this.ui.commandParameter = 1000;
        sinon.stub(this.game, "generator").returns(0);
        var energyBefore = this.game.e;

        // when
        this.game.processCommand(this.ui);

        // then
        equal(this.ui.writeLine.getCall(0).args[0], "Phasers hit Klingon at 2000 sectors with 500 units", "first message");
        equal(this.ui.writeLine.getCall(1).args[0], "Klingon destroyed!", "second message");
        equal(this.game.e, energyBefore - 1000, "energy deducted");
        ok(klingon.destroy.calledOnce, "klingon destroyed");
    });

    test("PhasersDamageOfZeroStillHits_AndNondestructivePhaserDamageDisplaysRemaining", function() {
        // given
        var minimalFired = 0;
        var minimalHit = 1;
        var klingon = new Klingon();
        klingon.distance = 2000;
        klingon.energy = 200;
        this.ui.target = klingon;
        this.ui.commandParameter = minimalFired;
        sinon.stub(this.game, "generator").returns(0);

        // when
        this.game.processCommand(this.ui);

        // then
        equal(this.ui.writeLine.getCall(0).args[0], "Phasers hit Klingon at 2000 sectors with " + minimalHit + " units", "first message");
        equal(this.ui.writeLine.getCall(1).args[0], "Klingon has 199 remaining", "second message");
        // Isn't this also a bug?  I *ask* to fire zero, and I still hit?
        // Acknowledge it, log it, but don't fix it yet!
    });

  </script>
</body>
</html>
