<!Doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>photonPinning.test</title>
  <link rel="stylesheet" href="../../../lib/qunit.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="../../../lib/qunit.js"></script>
  <script src="../../../lib/jquery.js"></script>
  <script src="../../../lib/sinon.js"></script>
  <script src="../StarTrek/game.js"></script>
  <script src="../StarTrek/klingon.js"></script>
  <script src="../Untouchables/userInterface.js"></script>
  <script>

    module("photon", {
        setup: function() {
			// given
            this.game = new Game();
            this.ui = new UserInterface("photon");
            sinon.stub(this.ui, "writeLine");
            sinon.stub(this.game, "generator", function() { return 1; }); // Note: without this the test would often fail
        }
    });

    test("NotifiedIfNoTorpedoesRemain", function() {
        // given
        this.game.t = 0;
        this.ui.target = new Klingon();

        // when
        this.game.processCommand(this.ui);

        // then
        equal(this.ui.writeLine.args[0], "No more photon torpedoes!", "message");
    });

    test("TorpedoMissesDueToRandomFactors", function() {
        // given
        var distanceWhereRandomFactorsHoldSway = 3000;
        this.ui.target = new Klingon(distanceWhereRandomFactorsHoldSway, 200);

        // when
        this.game.processCommand(this.ui);

        // then
        equal(this.ui.writeLine.args[0], "Torpedo missed Klingon at 3000 sectors...", "message");
        equal(this.game.t, 7, "torpedo count");
    });

    test("TorpedoMissesDueToDistanceAndCleverKlingonEvasiveActions", function() {
        // given
        var distanceWhereTorpedoesAlwaysMiss = 3500;
        this.ui.target = new Klingon(distanceWhereTorpedoesAlwaysMiss, 200);

        // when
        this.game.processCommand(this.ui);

        // then
        equal(this.ui.writeLine.args[0], "Torpedo missed Klingon at 3500 sectors...", "message");
        equal(this.game.t, 7, "torpedo count");
    });

    test("TorpedoDestroysKlingon", function() {
        // given
        var klingon = new Klingon(500, 200);
        sinon.spy(klingon, "destroy");
        this.ui.target = klingon;

        // when
        this.game.processCommand(this.ui);

        // then
        equal(this.ui.writeLine.getCall(0).args[0], "Photons hit Klingon at 500 sectors with 850 units", "first message");
        equal(this.ui.writeLine.getCall(1).args[0], "Klingon destroyed!", "second message");
        equal(this.game.t, 7, "torpedo count");
        ok(klingon.destroy.calledOnce, "klingon destroyed");
    });

    test("TorpedoDamagesKlingon", function() {
        // given
        this.ui.target = new Klingon(500, 2000);

        // when
        this.game.processCommand(this.ui);

        // then
        equal(this.ui.writeLine.getCall(0).args[0], "Photons hit Klingon at 500 sectors with 850 units", "first message");
        equal(this.ui.writeLine.getCall(1).args[0], "Klingon has 1150 remaining", "second message");
        equal(this.game.t, 7, "torpedo count");
    });

  </script>
</body>
</html>
